# 抓娃娃游戏厅（增量功能）+ 链上打卡（已完成）DApp 任务计划清单

本文档将项目按 4 个阶段拆解：
1) 纯前端游戏原型；2) 接入现有钱包与链上打卡状态（不改合约）；3) 游戏内容与表现力增强；4) 手势（摄像头）触发抓取（鼠标保底）。

## 0. 项目范围与原则

### 目标
- 主玩法是“抓娃娃”小游戏：用户可用鼠标/触控进行操作并完成“抓取”流程
- “打卡”作为附加成分：你现有的链上打卡保持不变；游戏侧把“今日已打卡”当作解锁/增益条件（例如解锁每日免费次数）
- 前端清晰展示：剩余次数、抓取结果记录、（可选）成就/徽章展示
- 逐步增强交互：先鼠标点击操作 → 后续升级为摄像头捕捉手势（握拳触发抓）

### 非目标（第一版先不做）
- 复杂的物理精度（高拟真碰撞、软体娃娃、复杂关节）
- 服务器端排行榜与反作弊系统（第一版尽量纯前端 + 链上状态）
- 完整的链上历史索引（第一版只依赖账户状态与前端本地记录）
- 多人联机/对战

### 技术约束
- 智能合约：你现有的打卡合约不变（本任务不新增/不修改合约）
- 前端：Next.js + TypeScript + Wallet Adapter
- 工具：@solana/web3.js, Anchor IDL（前端读取/调用现有打卡指令）
- 网络：devnet（与现有 DApp 保持一致）
- 摄像头手势：浏览器 MediaDevices + 手势识别（后期可选：MediaPipe Hands 或 TFJS 模型）

### 关键验收点（全程贯穿）
- 游戏可玩：完整完成一次“移动 → 下抓 → 抬起 → 判定”的回合
- 交互状态机清晰：未开始 / 操作中 / 抓取中 / 结算中 / 失败重试
- 打卡是“附加”：不打卡也能试玩（例如每日 1 次试玩）；打卡可解锁更多次数或更高成功率
- 不改合约：游戏权限/次数只依赖“是否已打卡”和本地计数（按地址 + UTC day 隔离）

## 1) 第 1 步：纯前端游戏原型（先独立可玩）

### 目标
- 先把“游戏厅抓娃娃”的玩法跑通：场景、娃娃、爪子、判定、UI
- 所有数据用本地 mock（不依赖网络、不依赖钱包）

### 任务清单
- 页面与路由
  - 首页：项目介绍、开始游戏按钮、玩法说明
  - 游戏页：游戏舞台（Canvas/DOM）、操作区、结果提示、次数展示（mock）
- 设计前端数据模型（TypeScript types）
  - 回合：开始时间、结束时间、是否成功、抓到的娃娃类型
  - 游戏状态：idle/moving/grabbing/resolving
  - 娃娃：id、名称、稀有度（可选）、图片/精灵帧信息
  - 次数：当前次数、每日上限（mock）、恢复时间（mock）
- 核心玩法实现（先“够用”，再追求精致）
  - 爪子移动：左右移动（鼠标点击或拖拽控制目标位置）
  - 抓取动作：点击“抓取”按钮 → 爪子下落 → 夹合 → 上升
  - 命中判定：简单 AABB/圆形距离判定即可（第一版无需精确物理）
  - 随机性：可配置“抓取成功率”与“掉落概率”，用于营造娱乐性
- UI 组件拆分（建议）
  - `GameStage`：渲染舞台与动画
  - `ClawController`：操作按钮/提示
  - `TurnsPanel`：剩余次数 + 回合状态
  - `ResultToast`：抓取结果弹窗
  - `PrizeShelf`（可选）：已抓到的娃娃墙（本地）
- Mock 数据与本地持久化（可选但推荐）
  - 用 LocalStorage 保存已抓到娃娃与最近 N 次结果
  - 刷新后仍可展示“收藏墙”

### 产出物
- 可演示的纯前端游戏页面（无钱包也能玩）
- UI 组件与类型定义（后续接链尽量不改 UI）

### 验收标准
- 鼠标点击/拖拽可控制爪子移动；点击抓取触发完整动画流程
- 至少 3 种娃娃素材可展示；抓取结果有明确反馈
- 本地状态（次数/收藏/结果）逻辑稳定且可重复演示

## 2) 第 2 步：接入现有钱包与链上打卡状态（不改合约）

### 目标
- 复用你现有的连接钱包与链上打卡能力，把“今日是否已打卡/累计打卡”等状态映射到游戏 UI
- 次数/收藏按钱包地址隔离；“每日次数”按 UTC day 隔离（仍在前端本地管理，不上链）
- 打卡作为增益：今日已打卡 → 解锁更多次数/更高成功率/特殊娃娃池（可选其一即可）

### 任务清单
- 接入现有链上状态（读取/调用都复用已有代码）
  - 读取“今日是否已打卡”（或读取 last_checkin_day 推断）
  - 保留现有打卡按钮与页面，但在游戏页增加轻量入口（例如“今日未打卡，去打卡解锁次数”）
- 设计“次数规则”（前端本地，不改合约）
  - 未打卡：每日免费 1 次（或 0 次）
  - 已打卡：每日免费 3 次（或增加 2 次）
  - 次数 key：`address + day_index`，避免刷新丢失与跨天串用
- 游戏联动逻辑
  - 每次开始抓取前扣 1 次数；次数不足时禁用并提示
  - 抓取成功将娃娃加入“收藏墙”，按地址隔离
- 抽象游戏侧服务层（便于后续手势/表现升级时不搅 UI）
  - 定义 `ArcadeService`（仅前端）：`getQuota()` / `consumeQuota()` / `getInventory()` / `addPrize()` / `getHistory()`

### 产出物
- 游戏页能展示链上打卡状态 + 今日可用次数，并与现有打卡流程连通
- 不改合约的前提下，完成“打卡作为增益”的体验闭环

### 验收标准
- 切换地址后：次数/收藏/历史互不影响
- 今日未打卡与已打卡的次数差异清晰可见；引导路径可用
- 次数不足时无法继续抓取；提示明确

## 3) 第 3 步：游戏内容与表现力增强（让“娱乐效果”明显提升）

### 目标
- 让游戏“像个游戏”：更顺滑的动画、音效/震动反馈、娃娃池与稀有度、结果展示更有戏剧性
- 仍保持打卡是附加：不让用户被链上流程打断主娱乐路径

### 验收标准
- 连续游玩 10 次仍流畅；动画与音效不会卡顿或错乱
- 结果提示有“爽感”（成功/失败两套反馈完整）
- 收藏墙与历史记录可稳定展示（按地址隔离）

### 任务清单
- 表现力增强
  - 爪子运动加入缓动（ease-in/out）、下落/夹合/回弹的节奏控制
  - 音效（成功/失败/按钮/爪子动作）与可选震动（移动端）
  - 视觉反馈：发光、粒子、闪烁边框、中奖播报条（可选）
- 玩法丰富（选做 1-2 项即可）
  - 娃娃稀有度与不同成功率（稀有更难抓）
  - “保底”机制：连续失败 N 次后提升成功率
  - 特殊娃娃池：今日已打卡可解锁限定娃娃（附加但不强制）
- 数据与可玩性
  - 回合历史：最近 N 次的结果与时间（本地）
  - 收藏墙：按稀有度排序/过滤（可选）

## 4) 第 4 步：娱乐升级（摄像头手势触发抓取）+ 可选链上成就/NFT

### 目标
- 将“抓取按钮”升级为“握拳触发抓取”的互动方式（保留鼠标作为备用）
- （可选）加入成就/徽章展示：优先做前端成就；如你后续想扩展再考虑链上 NFT

### 手势交互实现建议
- 摄像头接入
  - 浏览器请求摄像头权限（MediaDevices.getUserMedia）
  - UI 显示摄像头预览区（可小窗或设置页）
- 手势识别（二选一即可）
  - 方案 A：使用成熟手部关键点模型（例如 MediaPipe Hands），根据关键点判断“握拳”
  - 方案 B：简化版：只检测“手掌存在 + 收拢阈值”或使用简单分类模型
- 动作触发规则（必须可控）
  - 防抖：握拳持续 X ms 才触发一次
  - 冷却：触发后进入冷却时间，避免连续触发
  - 回退：摄像头不可用时自动降级为按钮/鼠标
- 状态机与可观测性
  - 明确显示“检测到手掌/未检测到”“已握拳/未握拳”
  - 提供校准按钮与阈值调节（可选）

### （可选）成就/徽章（推荐：先纯前端）
- 成就阈值示例
  - 累计抓到 1/5/20 个娃娃
  - 单日连抓成功 3 次
  - 今日打卡后首次抓取成功
- 展示与解锁
  - 徽章墙：锁定/点亮/已达成
  - 纯前端存储：按地址隔离即可，避免引入链上复杂度

### 产出物
- 摄像头模式可用：握拳触发抓取动作，并且可稳定演示
- （可选）至少 3 个成就徽章可完整演示（前端点亮）

### 验收标准
- 手势触发稳定：误触率可接受、可重复演示、可回退鼠标按钮
- 摄像头权限被拒绝或模型加载失败时，按钮/鼠标路径仍可用

### Demo 展示建议（路演友好）
- 现场演示 3 分钟流程：连接钱包 →（可选）打卡解锁次数 → 抓娃娃成功/失败 → 收藏墙变化 →（可选）握拳触发抓取

## 风险清单（提前规避）
- 摄像头权限：用户可能拒绝授权；必须有按钮/鼠标回退路径
- 光照与背景：手势识别对环境敏感；提供“识别状态”可视化与阈值调节
- 误触发：一定要有防抖与冷却机制，且触发逻辑与游戏状态机绑定
- 时区问题：按 UTC day 计算“今日次数”，前端文案需注明“按 UTC 计算”
- 链上交互干扰主玩法：打卡入口要轻量，失败/确认慢时不阻塞纯游戏试玩
